---
title: "feat: Add analysis fields to clip details sidebar with inline editing"
type: feat
date: 2026-01-27
---

# Add Analysis Fields to Clip Details Sidebar

## Overview

Add the 3 new analysis fields (Object Labels, Detected Objects, Description) to the clip details sidebar with inline editing support. These fields were added to the Analyze tab buttons in PR #24 but are not yet visible or editable in the sidebar.

## Problem Statement

**Current State:**
- The clip details sidebar displays: name, source info, metadata, shot type, colors, transcript
- The Clip model already has `object_labels`, `detected_objects`, `person_count`, and `description` fields
- Users can run analysis via Analyze tab buttons, but cannot view or edit results in the sidebar

**Impact:** Users cannot see or manually correct analysis results without using the agent chat.

## Proposed Solution

Add 3 new sections to the clip details sidebar:

| Field | Display | Edit Mode | Empty State |
|-------|---------|-----------|-------------|
| Object Labels | Comma-separated text | EditableLabel (single-line) | "Run Classify to analyze..." |
| Detected Objects | Summary: "2 person, 1 car" | **Read-only** | "Run Detect Objects to analyze..." |
| Person Count | "People detected: 3" | **Read-only** | (hidden when 0 or null) |
| Description | Multi-line text | New EditableTextArea widget | "Run Describe to analyze..." |

### Design Decisions

1. **Detected Objects is read-only** - The data includes bounding boxes and confidence scores that cannot be meaningfully edited as text. Users can re-run detection to update.

2. **Person Count is read-only** - Derived from detection results, shown separately for quick reference.

3. **Description uses multi-line editing** - Descriptions can be 200+ characters. A new `EditableTextArea` widget is needed (similar to EditableLabel but with QTextEdit).

4. **Object Labels uses comma parsing** - Split on comma, strip whitespace, preserve multi-word labels like "golden retriever".

5. **Placeholders are hints only** - Clicking placeholder text does not trigger analysis; it shows a tooltip explaining where to find analysis buttons.

6. **Description metadata shown below** - Display "Generated by [model]" in muted text below description. Clear when user manually edits.

## Technical Approach

### File Changes

#### 1. `ui/widgets/editable_text_area.py` (NEW FILE)

Create new widget for multi-line editable text, following EditableLabel patterns:

```python
class EditableTextArea(QWidget):
    """Multi-line editable text field with click-to-edit behavior.

    Similar to EditableLabel but uses QTextEdit for multi-line support.
    """
    value_changed = Signal(str)

    def __init__(self, text: str = "", placeholder: str = "", parent=None):
        # Dual widget: QLabel (display) + QTextEdit (edit)
        # Click label to edit, Ctrl+Enter or blur to save, Escape to cancel
        pass
```

Key behaviors:
- Display mode: QLabel with word wrap, max 4 lines visible
- Edit mode: QTextEdit with auto-resize (min 3 lines, max 8 lines)
- Save on Ctrl+Enter or focus loss
- Cancel on Escape
- Placeholder shown in muted italic when empty

#### 2. `ui/clip_details_sidebar.py` - Add new fields

**Add widgets** (after shot_type_dropdown, before transcript):

```python
# Object Labels section
self.object_labels_header = QLabel("OBJECT LABELS")
self._apply_section_header_style(self.object_labels_header)
self.object_labels_edit = EditableLabel("", placeholder="Run Classify to analyze...")
self.object_labels_edit.value_changed.connect(self._on_object_labels_changed)

# Detected Objects section (read-only)
self.detected_objects_header = QLabel("DETECTED OBJECTS")
self._apply_section_header_style(self.detected_objects_header)
self.detected_objects_label = QLabel("")  # Read-only display
self.detected_objects_label.setWordWrap(True)

# Person Count (read-only, inline with detected objects)
self.person_count_label = QLabel("")

# Description section
self.description_header = QLabel("DESCRIPTION")
self._apply_section_header_style(self.description_header)
self.description_edit = EditableTextArea("", placeholder="Run Describe to analyze...")
self.description_edit.value_changed.connect(self._on_description_changed)
self.description_meta_label = QLabel("")  # "Generated by moondream-2b"
```

**Add guard flags**:

```python
self._object_labels_change_in_progress = False
self._description_change_in_progress = False
```

**Add change handlers**:

```python
@Slot(str)
def _on_object_labels_changed(self, new_value: str):
    """Handle object labels edit."""
    if self._object_labels_change_in_progress or self._loading:
        return
    if not self._clip_ref:
        return
    self._object_labels_change_in_progress = True

    # Parse comma-separated to list
    if new_value.strip():
        labels = [l.strip() for l in new_value.split(",") if l.strip()]
        self._clip_ref.object_labels = labels if labels else None
    else:
        self._clip_ref.object_labels = None

    self.clip_edited.emit(self._clip_ref)
    self._object_labels_change_in_progress = False

@Slot(str)
def _on_description_changed(self, new_value: str):
    """Handle description edit."""
    if self._description_change_in_progress or self._loading:
        return
    if not self._clip_ref:
        return
    self._description_change_in_progress = True

    self._clip_ref.description = new_value.strip() if new_value.strip() else None
    # Clear model metadata on manual edit
    self._clip_ref.description_model = None
    self._clip_ref.description_frames = None

    self.clip_edited.emit(self._clip_ref)
    self._description_change_in_progress = False
```

**Update `show_clip()`** to populate new fields:

```python
# Block signals for new fields
self.object_labels_edit.blockSignals(True)
self.description_edit.blockSignals(True)

# Populate object labels
if clip.object_labels:
    self.object_labels_edit.setText(", ".join(clip.object_labels))
else:
    self.object_labels_edit.setText("")

# Populate detected objects (read-only summary)
if clip.detected_objects:
    # Count by label: {"person": 2, "car": 1}
    counts = {}
    for obj in clip.detected_objects:
        label = obj.get("label", "unknown")
        counts[label] = counts.get(label, 0) + 1
    summary = ", ".join(f"{count} {label}" for label, count in counts.items())
    self.detected_objects_label.setText(summary)
    self.detected_objects_label.setStyleSheet(f"color: {theme().text_primary};")
else:
    self.detected_objects_label.setText("Run Detect Objects to analyze...")
    self.detected_objects_label.setStyleSheet(f"color: {theme().text_muted}; font-style: italic;")

# Populate person count
if clip.person_count and clip.person_count > 0:
    self.person_count_label.setText(f"People detected: {clip.person_count}")
    self.person_count_label.setVisible(True)
else:
    self.person_count_label.setVisible(False)

# Populate description
if clip.description:
    self.description_edit.setText(clip.description)
    # Show metadata if available
    if clip.description_model:
        meta = f"Generated by {clip.description_model}"
        if clip.description_frames and clip.description_frames > 1:
            meta += f" ({clip.description_frames} frames)"
        self.description_meta_label.setText(meta)
        self.description_meta_label.setVisible(True)
    else:
        self.description_meta_label.setVisible(False)
else:
    self.description_edit.setText("")
    self.description_meta_label.setVisible(False)

# Unblock signals
self.object_labels_edit.blockSignals(False)
self.description_edit.blockSignals(False)
```

**Update `_set_editing_enabled()`**:

```python
def _set_editing_enabled(self, enabled: bool):
    self.name_edit.setEnabled(enabled)
    self.shot_type_dropdown.setEnabled(enabled)
    self.object_labels_edit.setEnabled(enabled)  # NEW
    self.description_edit.setEnabled(enabled)    # NEW
    self.transcript_edit.setEnabled(enabled)
    # Note: detected_objects and person_count are always read-only
```

**Update multi-selection handling**:

```python
# In show_multiple_clips():
self.object_labels_edit.setPlaceholder(f"{count} clips selected")
self.object_labels_edit.setText("")
self.detected_objects_label.setText("Select a single clip to view details")
self.person_count_label.setVisible(False)
self.description_edit.setPlaceholder(f"{count} clips selected")
self.description_edit.setText("")
self.description_meta_label.setVisible(False)
```

#### 3. `ui/widgets/__init__.py` - Export new widget

```python
from .editable_text_area import EditableTextArea
```

## Acceptance Criteria

### Functional Requirements

- [x] Object Labels field appears in sidebar after Shot Type section
- [x] Object Labels displays comma-separated list when populated
- [x] Object Labels shows placeholder "Run Classify to analyze..." when empty
- [x] Object Labels is editable via click-to-edit pattern
- [x] Object Labels changes save to clip model and emit `clip_edited`
- [x] Detected Objects field appears after Object Labels
- [x] Detected Objects displays summary like "2 person, 1 car" when populated
- [x] Detected Objects shows placeholder when empty
- [x] Detected Objects is NOT editable (read-only)
- [x] Person Count appears below Detected Objects when > 0
- [x] Person Count is hidden when 0 or null
- [x] Description field appears after Detected Objects
- [x] Description displays multi-line text when populated
- [x] Description shows placeholder "Run Describe to analyze..." when empty
- [x] Description is editable via click-to-edit (multi-line)
- [x] Description changes save to clip model and emit `clip_edited`
- [x] Description metadata ("Generated by...") appears below when model info exists
- [x] Description metadata is cleared when user manually edits

### Non-Functional Requirements

- [x] New fields follow existing styling patterns (section headers, muted placeholders)
- [x] EditableTextArea widget matches EditableLabel behavior (Escape cancel, blur save)
- [x] All new fields use signal blocking pattern in `show_clip()`
- [x] All editable fields use guard flags to prevent duplicate signal handling
- [x] Fields disabled during multi-clip selection

### Quality Gates

- [x] No regressions in existing sidebar functionality
- [x] Theme changes update new field colors correctly
- [x] Project saves include edited analysis data

## Implementation Notes

### Existing Patterns to Follow

- **EditableLabel** (`ui/widgets/editable_label.py:13-190`): Dual widget with QLabel + QLineEdit
- **Signal blocking** (`ui/clip_details_sidebar.py:310-346`): Block signals when loading data
- **Guard flags** (`ui/clip_details_sidebar.py:78-80`): Prevent duplicate change handling
- **Section headers** (`ui/clip_details_sidebar.py:197-205`): Uppercase, muted, letter-spacing

### Learnings to Apply

From `docs/solutions/ui-bugs/timeline-widget-sequence-mismatch-20260124.md`:
- Use `self._clip_ref` directly (reference, not copy) - changes persist automatically
- Don't create separate copies of clip data in the sidebar

### Clip Model Fields (reference)

```python
# models/clip.py:114-136
object_labels: Optional[list[str]] = None              # ["dog", "car", "tree"]
detected_objects: Optional[list[dict]] = None          # [{label, confidence, bbox}]
person_count: Optional[int] = None                     # Integer count
description: Optional[str] = None                      # Natural language text
description_model: Optional[str] = None                # "moondream-2b", "gpt-4o"
description_frames: Optional[int] = None               # 1 or N for temporal
```

## References

### Internal References

- Clip details sidebar: `ui/clip_details_sidebar.py:42-519`
- EditableLabel widget: `ui/widgets/editable_label.py:13-190`
- Clip model: `models/clip.py:114-265`
- Theme system: `ui/theme.py:1-116`

### Related Work

- PR #24: Added Classify, Detect Objects, Describe buttons to Analyze tab
